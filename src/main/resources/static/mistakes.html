<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤±è¯¯ç»Ÿè®¡ - Stockfish åˆ†æç³»ç»Ÿ</title>
    <script src="vendor/vue.global.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/settings-manager.js"></script>
    <link rel="stylesheet" href="/css/navbar.css">
    <script src="/js/navbar.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --blunder: #f5222d;
            --mistake: #faad14;
            --inaccuracy: #ff7875;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        #app {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 8px;
        }
        
        .header-subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-value.total { color: var(--primary); }
        .stat-value.blunder { color: var(--blunder); }
        .stat-value.mistake { color: var(--mistake); }
        .stat-value.inaccuracy { color: var(--inaccuracy); }
        
        .stat-label {
            font-size: 12px;
            color: #999;
        }
        
        .content-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .content-box h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .filter-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid;
            transition: all 0.3s;
        }
        
        .badge.blunder { border-color: var(--blunder); color: var(--blunder); }
        .badge.blunder.active { background: var(--blunder); color: white; }
        .badge.mistake { border-color: var(--mistake); color: var(--mistake); }
        .badge.mistake.active { background: var(--mistake); color: white; }
        .badge.inaccuracy { border-color: var(--inaccuracy); color: var(--inaccuracy); }
        .badge.inaccuracy.active { background: var(--inaccuracy); color: white; }
        
        .mistake-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mistake-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .mistake-item.BLUNDER { border-left-color: var(--blunder); }
        .mistake-item.MISTAKE { border-left-color: var(--mistake); }
        .mistake-item.INACCURACY { border-left-color: var(--inaccuracy); }
        
        .mistake-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .mistake-tag {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .mistake-tag.BLUNDER { background: var(--blunder); }
        .mistake-tag.MISTAKE { background: var(--mistake); }
        .mistake-tag.INACCURACY { background: var(--inaccuracy); }
        
        .mistake-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            font-size: 13px;
            color: #666;
        }
        
        .mistake-info strong {
            color: #333;
            font-weight: 600;
        }
        
        .loading, .error, .empty {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.2);
            border-radius: 10px;
            color: #fff;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="loading" class="loading">
            â³ æ­£åœ¨åŠ è½½å¤±è¯¯æ•°æ®...
        </div>

        <div v-else-if="error" class="error">
            âŒ {{ error }}
            <br><br>
            <button class="btn btn-primary" @click="loadData">é‡è¯•</button>
        </div>

        <template v-else>
            <div class="header">
                <h1>ğŸ“Š å¤±è¯¯ç»Ÿè®¡åˆ†æ</h1>
                <p class="header-subtitle">åˆ†æä½ çš„å¤±è¯¯ï¼Œæå‡æ£‹è‰ºæ°´å¹³</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>æ€»å¤±è¯¯æ•°</h3>
                    <div class="stat-value total">{{ stats.total }}</div>
                    <p class="stat-label">æ‰€æœ‰ç±»å‹å¤±è¯¯</p>
                </div>
                <div class="stat-card">
                    <h3>æ¼ç€ (Blunder)</h3>
                    <div class="stat-value blunder">{{ stats.blunders }}</div>
                    <p class="stat-label">è¯„åˆ†æŸå¤± â‰¥ 3.0</p>
                </div>
                <div class="stat-card">
                    <h3>å¤±è¯¯ (Mistake)</h3>
                    <div class="stat-value mistake">{{ stats.mistakes }}</div>
                    <p class="stat-label">1.5 â‰¤ æŸå¤± < 3.0</p>
                </div>
                <div class="stat-card">
                    <h3>ä¸ç²¾å‡† (Inaccuracy)</h3>
                    <div class="stat-value inaccuracy">{{ stats.inaccuracies }}</div>
                    <p class="stat-label">0.5 â‰¤ æŸå¤± < 1.5</p>
                </div>
            </div>

            <div class="content-box">
                <h2>ğŸ” ç­›é€‰æ¡ä»¶</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label>æœç´¢</label>
                        <input v-model="search" type="text" placeholder="æœç´¢å¯¹å±€IDã€èµ°æ³•..." style="width: 250px;">
                    </div>
                    <div class="filter-group">
                        <label>æ’åº</label>
                        <select v-model="sortBy">
                            <option value="scoreDrop">æŒ‰è¯„åˆ†æŸå¤±</option>
                            <option value="moveNumber">æŒ‰æ­¥æ•°</option>
                            <option value="gameId">æŒ‰å¯¹å±€ID</option>
                        </select>
                    </div>
                </div>
                <div class="filter-badges">
                    <div class="badge blunder" :class="{ active: filters.blunder }" @click="filters.blunder = !filters.blunder">
                        æ¼ç€ ({{ stats.blunders }})
                    </div>
                    <div class="badge mistake" :class="{ active: filters.mistake }" @click="filters.mistake = !filters.mistake">
                        å¤±è¯¯ ({{ stats.mistakes }})
                    </div>
                    <div class="badge inaccuracy" :class="{ active: filters.inaccuracy }" @click="filters.inaccuracy = !filters.inaccuracy">
                        ä¸ç²¾å‡† ({{ stats.inaccuracies }})
                    </div>
                </div>
            </div>

            <div class="content-box">
                <h2>ğŸ“‹ å¤±è¯¯è¯¦æƒ…åˆ—è¡¨ ({{ filteredList.length }} æ¡)</h2>

                <div v-if="filteredList.length === 0" class="empty" style="color: #999;">
                    ğŸ˜Š æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å¤±è¯¯<br>
                    <small>å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶</small>
                </div>

                <div v-for="item in filteredList" :key="`${item.gameId}-${item.moveNumber}`" 
                     class="mistake-item" 
                     :class="item.classification"
                     @click="viewDetail(item)">
                    <div class="mistake-header">
                        <span class="mistake-tag" :class="item.classification">
                            {{ getTypeName(item.classification) }}
                        </span>
                        <span style="font-size: 12px; color: #999;">
                            å¯¹å±€ #{{ item.gameId }} | ç¬¬ {{ item.moveNumber }} æ­¥
                        </span>
                    </div>
                    <div class="mistake-info">
                        <div><strong>å®é™…èµ°æ³•:</strong> {{ item.move || 'N/A' }}</div>
                        <div><strong>æœ€ä½³èµ°æ³•:</strong> {{ item.bestMove || 'N/A' }}</div>
                        <div>
                            <strong>è¯„åˆ†æŸå¤±:</strong> 
                            <span style="color: var(--blunder); font-weight: bold;">
                                {{ formatDrop(item.scoreDrop) }}å…µ
                            </span>
                        </div>
                        <div>
                            <strong>å¯¹å±€:</strong> 
                            {{ item.whiteName || 'White' }} vs {{ item.blackName || 'Black' }}
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    userId: 5,
                    loading: true,
                    error: null,
                    rawData: null,
                    search: '',
                    sortBy: 'scoreDrop',
                    filters: {
                        blunder: true,
                        mistake: true,
                        inaccuracy: true
                    }
                };
            },
            computed: {
                stats() {
                    if (!this.rawData) return { total: 0, blunders: 0, mistakes: 0, inaccuracies: 0 };
                    return {
                        total: this.rawData.totalMistakes || 0,
                        blunders: this.rawData.totalBlunders || 0,
                        mistakes: this.rawData.totalMistakesCount || 0,
                        inaccuracies: this.rawData.totalInaccuracies || 0
                    };
                },
                allMistakes() {
                    return this.rawData?.mistakes || [];
                },
                filteredList() {
                    let list = this.allMistakes.filter(m => {
                        // ç±»å‹è¿‡æ»¤
                        if (m.classification === 'BLUNDER' && !this.filters.blunder) return false;
                        if (m.classification === 'MISTAKE' && !this.filters.mistake) return false;
                        if (m.classification === 'INACCURACY' && !this.filters.inaccuracy) return false;
                        
                        // æœç´¢è¿‡æ»¤
                        if (this.search) {
                            const q = this.search.toLowerCase();
                            const text = `${m.gameId} ${m.move} ${m.bestMove}`.toLowerCase();
                            if (!text.includes(q)) return false;
                        }
                        
                        return true;
                    });
                    
                    // æ’åº
                    list.sort((a, b) => {
                        if (this.sortBy === 'scoreDrop') {
                            return Math.abs(b.scoreDrop || 0) - Math.abs(a.scoreDrop || 0);
                        } else if (this.sortBy === 'moveNumber') {
                            return (a.gameId - b.gameId) || (a.moveNumber - b.moveNumber);
                        } else if (this.sortBy === 'gameId') {
                            return b.gameId - a.gameId;
                        }
                        return 0;
                    });
                    
                    return list;
                }
            },
            mounted() {
                this.loadData();
            },
            methods: {
                async loadData() {
                    this.loading = true;
                    this.error = null;
                    
                    try {
                        const res = await fetch(`/api/analysis/mistakes/${this.userId}`);
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        
                        this.rawData = await res.json();
                    } catch (err) {
                        this.error = `åŠ è½½å¤±è´¥: ${err.message}`;
                    } finally {
                        this.loading = false;
                    }
                },
                getTypeName(type) {
                    const names = { BLUNDER: 'æ¼ç€', MISTAKE: 'å¤±è¯¯', INACCURACY: 'ä¸ç²¾å‡†' };
                    return names[type] || type;
                },
                formatDrop(drop) {
                    if (!drop) return '0.00';
                    return (Math.abs(drop) / 100).toFixed(2);
                },
                viewDetail(item) {
                    const msg = `å¯¹å±€ #${item.gameId} ç¬¬ ${item.moveNumber} æ­¥å¤±è¯¯\n\n` +
                        `ç±»å‹: ${this.getTypeName(item.classification)}\n` +
                        `å®é™…èµ°æ³•: ${item.move || 'N/A'}\n` +
                        `æœ€ä½³èµ°æ³•: ${item.bestMove || 'N/A'}\n` +
                        `è¯„åˆ†æŸå¤±: ${this.formatDrop(item.scoreDrop)}å…µ\n\n` +
                        `å¯¹å±€: ${item.whiteName || 'White'} vs ${item.blackName || 'Black'}\n` +
                        `ç»“æœ: ${item.result || 'N/A'}`;
                    alert(msg);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
