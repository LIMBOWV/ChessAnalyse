


# 项目规范书：《基于开源AI引擎的国际象棋Web复盘系统》 (Project: Zeus)

[![Java 17](https://img.shields.io/badge/Backend-Java%2017-blue.svg?style=flat-square&logo=java)](https://spring.io/)
[![Spring Boot 3.x](https://img.shields.io/badge/Framework-Spring%20Boot%203.x-brightgreen.svg?style=flat-square&logo=spring)](https://spring.io/)
[![Vue.js 3](https://img.shields.io/badge/Frontend-Vue.js%203-brightgreen.svg?style=flat-square&logo=vuedotjs)](https://vuejs.org/)
[![Stockfish](https://img.shields.io/badge/AI%20Engine-Stockfish-orange.svg?style=flat-square)](https://stockfishchess.org/)

**一个专为专业用户和研究者打造的、可 100% 私有化部署的、异步高性能国际象棋复盘平台。**

---

## 1. 核心价值 (Why this project?)

本项目旨在解决现有国际象棋分析工具的两大痛点：

1.  **“浏览器方案” (`stockfish.js`) 的缺陷：**
    * **体验差：** 阻塞UI，导致客户端CPU占满、发热。
    * **质量低：** 分析质量完全依赖用户设备，服务质量 (QoS) 无法保证。
    * **效率低：** 无法缓存分析结果，导致海量重复计算。
2.  **“公共服务” (Lichess/Chess.com) 的缺陷：**
    * **隐私风险：** 机密的开局准备 (Opening Novelties) 必须上传至第三方服务器。
    * **成本高昂：** 深度分析功能通常为付费墙 (Paywall) 内容。
    * **控制权低：** 无法自由切换、对比不同版本的 AI 引擎。

本项目通过 **“后端计算卸载 (Computation Offloading)”** 和 **“私有化部署 (Self-Hosted)”** 架构，完美解决了以上所有问题。

## 2. 核心功能 (Features)

* **PGN 棋谱上传：** 支持标准 PGN 文件的上传、解析与数据库持久化。
* **异步分析服务 (`@Async`)：**
    * 分析任务在**后端服务器**异步执行，用户上传后可立即关闭浏览器，无需等待。
    * 支持**分析结果缓存**，相同棋局（被不同用户上传）**无需重复分析**，实现秒级响应。
* **核心IPC引擎集成：**
    * 通过**进程间通信 (IPC)**，在 Java 后端**跨语言调用**原生 C++ `Stockfish` 引擎，实现服务器级高性能分析。
* **✨ 自研亮点：启发式走法分类算法：**
    * **本项目自研算法** 基于 Stockfish 返回的原始局面分，通过启发式规则 (Heuristic Rules) 引擎，自动为每一步棋标注 **“妙手 (Brilliant !!)”**、**“好棋 (Good)”**、**“失误 (Mistake)”**、**“大漏着 (Blunder)”** 标签，复现类 Chess.com 的游戏报告体验。
* **前端可视化 (Vue)：**
    * 使用 `chessboard.js` 实现交互式棋盘复盘。
    * 使用 `ECharts` (可选) 绘制全局局势评分曲线。
    * 直观展示 AI 推荐的最佳走法（高亮箭头）和（自研算法算出的）走法分类图标 (😱, ✨)。

## 3. 技术栈 (Technology Stack)

| 领域 | 技术 | 核心职责 |
| :--- | :--- | :--- |
| **后端** | `Spring Boot 3.x` | 异步服务框架 / RESTful API |
| | `Spring Data JPA` | 数据库持久化层 |
| | `Spring Async` | **核心亮点：** 异步任务处理 |
| **数据库** | `MySQL 8.x` | 存储棋局与分析结果（缓存） |
| **核心引擎**| `Stockfish` (Native) | C++ AI 引擎 (计算核心) |
| | `neat-chess` (Lib) | **核心亮点：** Java-UCI 进程通信库 (或自研IPC) |
| **前端** | `Vue 3` | 响应式 UI 框架 |
| | `chessboard.js` | 棋盘可视化与交互 |
| **开发工具** | `Lombok` | 提高 Java 编码效率 |
| | `Maven` | 项目依赖管理 |

## 4. 架构简图 (Architecture)

```text
(用户浏览器)           (后端服务器 Java)               (外部进程 C++)
+-----------+         +-------------------------+     +-------------+
|           |         |                         |     |             |
|  Vue.js   | --API-> |  Spring Boot Controller |     |  Stockfish  |
|  (棋盘)    |         |                         |     |   Engine    |
+-----------+         +-------------------+     |     |             |
                      |   @Async Service        |     |  -- IPC-->  |
                      |  (StockfishService)     |     |  <--UCI--   |
                      +-------------------+     |     +-------------+
                      |                         |
                      +-------------------+     |
                      |   JPA Repository        |     |
                      +-------------------+     |
                      |                         |
                      +-------------------+     |
                      |    MySQL DB             |     |
                      | (Cache & PGN Data)      |     |
                      +-------------------+     |
                      +-------------------------+
````

-----

# 详细项目开发任务书 (WBS)

## 1\. 项目概述 (Project Overview)

### 1.1. 项目背景

在国际象棋领域，使用AI引擎进行对局复盘是棋手提升水平的核心途径。然而，现有的专业桌面软件（如ChessBase）价格高昂且平台受限，而Web端服务（如Lichess）则依赖于平台服务器，无法实现私有化部署和深度定制。

### 1.2. 项目目标

本项目旨在研发一个基于B/S（浏览器/服务器）架构的轻量级、零成本的国际象棋复盘系统。系统通过在后端服务器集成业界顶级的开源AI引擎 (Stockfish)，对用户上传的PGN (Portable Game Notation) 棋谱进行异步智能分析，并通过Web前端实现分析结果的可视化，为用户提供一个可私有化部署的专业复盘工具。

### 1.3. 核心价值

本项目不仅是一个简单的CRUD（增删改查）应用，其核心技术挑战在于后端Java服务与外部C++高性能AI引擎（Stockfish）之间的进程间通信（IPC）、UCI协议解析以及异步任务处理。

## 2\. 系统架构与技术选型

### 2.1. 系统架构

本项目采用前后端分离的架构。

  * **前端 (Frontend)**: `Vue 3`。负责界面渲染、用户交互、棋盘可视化，并通过RESTful API与后端通信。
  * **后端 (Backend)**: `Spring Boot 3`。负责业务逻辑、API接口、数据库交互，并通过IPC调用外部AI引擎。
  * **数据库 (Database)**: `MySQL 8`。负责持久化存储用户信息、棋局数据及分析结果。
  * **AI引擎 (Engine)**: `Stockfish`。作为外部可执行程序，由后端服务在需要时调用。

### 2.2. 技术栈 (Technology Stack)

| 领域 | 技术 | 备注 (全部免费) |
| :--- | :--- | :--- |
| 后端 | Spring Boot, Spring Data JPA, Spring Async | 业务逻辑与异步任务 |
| 前端 | Vue 3, Vite, Axios | 响应式UI框架 |
| 数据库 | MySQL 8.x | 持久化存储 |
| 核心引擎 | Stockfish (Latest Version) | 开源AI引擎 (需本地安装) |
| 前端库 | chessboard.js (或 vue-chessboard) | PGN棋盘可视化 |
| 图表库 | ECharts (可选) | 局势评分曲线图 |
| Java库 | java-pgn-parser (示例) | 用于解析PGN文件 |

## 3\. 核心功能模块 (Work Breakdown Structure - WBS)

### 3.1. 模块一：基础服务与棋谱管理 (Backend & Database)

#### 3.1.1. 数据库设计 (Schema Design)

  * `tbl_user`: 用户表 (简化设计)。
  * `tbl_game_pgn`: 棋局表 (存储PGN原文, 对局信息, 上传者User\_ID, 分析状态)。
  * `tbl_analysis_result`: 分析结果表 (关联Game\_ID, 步数(Move\_Num), AI评分(Score), AI最佳走法(Best\_Move))。
  * `move_classification` VARCHAR(20) 或 ENUM(新增): 存储“自研算法”判定的走法分类结果 (e.g., 'BLUNDER', 'MISTAKE', 'BRILLIANT')。

#### 3.1.2. PGN上传与解析 (API: `/api/pgn/upload`)

  * 实现文件上传接口。
  * 调用PGN解析库，校验PGN格式合法性。
  * 将解析后的棋局元信息（对局方、结果等）及PGN原文存入 `tbl_game_pgn`，并将“分析状态”置为“待分析(Pending)”。

### 3.2. 模块二：核心AI分析服务 (Backend - Core)

#### 3.2.1. 进程间通信(IPC)服务 (StockfishService.java)

  * **职责：** 封装对 Stockfish 进程的调用。
  * **实现：** 使用 `ProcessBuilder` 启动 Stockfish 外部进程。
  * **关键：** 获取进程的 `OutputStream` (用于发送UCI命令) 和 `InputStream` (用于读取引擎输出)，必须采用异步I/O或独立线程读取，防止I/O缓冲区满导致主进程阻塞。

#### 3.2.2. UCI协议交互封装

  * **职责：** 实现UCI (Universal Chess Interface) 协议的文本命令发送与响应解析。
  * **实现：** 封装 `sendCommand(String cmd)` 和 `readResponse(String untilToken)` 等方法。
  * **示例流程：** 发送 `position startpos moves ...` (设置局面) → 发送 `go depth 18` (开始分析) → 异步读取 `info ...` (分析详情) → 阻塞等待 `bestmove ...` (最终结果)。

#### 3.2.3. 异步分析任务 (`@Async`)

  * **职责：** 当PGN上传成功后，自动触发一个Spring异步任务执行分析。
  * **实现：** 遍历该棋局的每一步：
    1.  调用IPC服务，将当前局面发送给Stockfish (T3.2.2)。
    2.  获取Stockfish返回的 `score` (评分) 和 `bestmove` (最佳走法)。
    3.  **(调用算法)**：将获取到的 `Score_A` 和 `Score_B` 传入 3.2.4 的“启发式走法分类算法”中，得到分类结果 (如 'BLUNDER')。
    4.  **(存储完整数据)**：将 `score`, `bestmove` 以及这个 `move_classification` 结果，一同持久化存入 `tbl_analysis_result`。
  * 分析完成后，更新 `tbl_game_pgn` 的状态为“已完成(Completed)”。

#### 3.2.4. (新增亮点) 启发式走法分类算法 (自研)

  * **职责：** 本项目的核心自研算法模块。负责将 Stockfish 返回的原始、冰冷的“局面分”，转化为用户可理解的、具有指导意义的“走法分类”。
  * **输入：** `Score_A` (AI 认为的最佳走法分数), `Score_B` (用户实际走法分数), `Score_C` (AI 认为的次佳走法分数, 可选)。
  * **算法核心 (启发式规则)：**
    1.  计算\*\*“评估损失 (Evaluation Loss)”\*\*：`Delta = Score_A - Score_B`。
    2.  基于可配置的阈值 (Thresholds)（例如：`blunder_threshold = 3.0`, `mistake_threshold = 1.5`）对 `Delta` 进行 `if-else` 判断，将其分类为 'BLUNDER', 'MISTAKE', 'INACCURACY', 'GOOD'。
    3.  **(核心创新点)** 设计“妙手 (BRILLIANT)”的判定逻辑，例如：必须是最佳走法 (`Delta == 0`)，且其收益远高于次佳走法 (`Score_A - Score_C > 1.0`)，且（可选）涉及弃子。
  * **输出：** 一个 `MoveClassification` 枚举值或字符串。

### 3.3. 模块三：前端可视化与复盘 (Frontend - Vue)

#### 3.3.1. 棋局大厅页

  * **职责：** 展示用户已上传的棋局列表。
  * **实现：** 调用后端API，获取 `tbl_game_pgn` 列表，显示对局信息及“分析状态”。

#### 3.3.2. 复盘详情页 (Core UI)

  * **职责：** 核心复盘界面。
  * **实现：**
      * 集成 `chessboard.js`，根据PGN数据初始化棋盘。
      * 提供“上一步”、“下一步”、“自动播放”等控制按钮。

#### 3.3.3. 分析结果展示

  * **职责：** 将后端分析结果实时同步到UI。
  * **实现：** 当用户在棋盘上走到某一步时：
    1.  前端异步请求后端API (`/api/analysis/get?gameId=...&moveNum=...`)。
    2.  后端从 `tbl_analysis_result` 查询该步的 `score` 和 `bestmove`。
    3.  前端将 `score` 显示在界面上，并将 `bestmove` (AI推荐走法) 以高亮箭头形式绘制在棋盘上。
    4.  **[关键]** 前端在获取到 `score` 和 `bestmove` 的同时，还需获取 `move_classification` 字段。
    5.  **[关键]** **必须**根据该字段的值，在棋盘旁或走法列表上，显示直观的分类图标（例如：‘妙手’✨, ‘漏着’😱, ‘失误’😟），以实现类 Chess.com 的‘游戏报告’用户体验。

#### 3.3.4. (可选) 局势图表 (ECharts)

  * **职责：** 提供宏观局势概览。
  * **实现：** 一次性获取整局所有步数的 `score`，使用 ECharts 绘制成局势评分折线图。

## 4\. 项目里程碑 (Milestones)

| 阶段 | 时间周期 (示例) | 核心产出物 | 验收标准 |
| :--- | :--- | :--- | :--- |
| M1 | Week 1-2 | `StockfishService.java` | 成功通过Java主函数启动Stockfish，发送`go`命令并正确解析返回的`bestmove`。 |
| M2 | Week 3-4 | 基础的前后端项目 | 完成T3.1.1, T3.1.2。实现PGN上传、数据库存储，前端能显示列表。 |
| M3 | Week 5-6 | 异步分析服务 | 完成T3.2.3。实现PGN上传后，后端自动异步分析，并成功将结果存入数据库。 |
| M4 | Week 7-8 | 复盘详情页 | 完成T3.3.3。前端棋盘能与后端数据联动，正确显示AI评分和推荐走法。 |
| M5 | Week 9-10| (可选 T3.3.4), 答辩PPT | 系统稳定，功能完善，完成项目文档和答辩材料。 |

## 5\. 风险与预案 (Risks & Mitigation)

  * **[高] IPC 阻塞风险：**
      * *描述：* Stockfish 进程的 `InputStream` 或 `ErrorStream` 缓冲区写满，导致 `Process.waitFor()` 或Java主线程永久阻塞。
      * *预案：* **必须**使用独立的线程（或NIO）来异步、非阻塞地消费 `InputStream` 和 `ErrorStream`。
  * **[中] 分析性能风险：**
      * *描述：* Stockfish 分析深度(`depth`)设置过高，导致单步分析时间过长，用户等待体验差，服务器CPU占用率高。
      * *预案：* T3.2.3中的分析指令 (`go`) 应使用 `movetime` (如 `go movetime 1000`，分析1秒) 而非 `depth`，确保分析时间可控。
  * **[低] PGN 格式多样性风险：**
      * *描述：* 网上下载的PGN文件格式不标准（如包含过多注释、变着），导致T3.1.2解析失败。
      * *预案：* 选用鲁棒性强(Robust)的PGN解析库，并做好异常捕获(Try-Catch)。

-----

## 附录A：数据库实体关系图 (ER Diagram)

使用 `Mermaid` 语法绘制，用于清晰展示实体间的“一对多”关系。

```mermaid
erDiagram
    %% 定义实体 (方块)
    tbl_user {
        BIGINT id (PK) "主键ID (唯一身份证)"
        VARCHAR(50) username "用户名"
        VARCHAR(255) password_hash "密码 (加密后)"
        DATETIME created_at "注册时间"
    }

    tbl_game_pgn {
        BIGINT id (PK) "棋局ID (唯一身份证)"
        BIGINT user_id (FK) "外键 -> 关联tbl_user.id"
        TEXT pgn_content "PGN原文"
        ENUM analysis_status "分析状态 (PENDING, COMPLETED...)"
        VARCHAR white_player "白方"
        VARCHAR black_player "黑方"
        DATETIME uploaded_at "上传时间"
    }

    tbl_analysis_result {
        BIGINT id (PK) "分析结果ID (唯一身份证)"
        BIGINT game_id (FK) "外键 -> 关联tbl_game_pgn.id"
        INT move_number "步数 (第几步)"
        VARCHAR move_san "走法 (e.g., e4)"
        VARCHAR score "AI评分"
        VARCHAR best_move "AI推荐走法"
        ENUM move_classification "走法分类 (BLUNDER, BRILLIANT...)"
    }

    %% 定义关系 (连线)
    %% 语法: 实体A ||--o{ 实体B : "关系描述"
    %% ||--o{ 的意思是 "一对多" (One-to-Many)

    tbl_user ||--o{ tbl_game_pgn : "上传"
    %% 解释: 一个用户 (User) '可以' 上传 '多'个棋局 (Game)

    tbl_game_pgn ||--o{ tbl_analysis_result : "包含"
    %% 解释: 一个棋局 (Game) '包含' '多'条分析结果 (Analysis Result) (因为一局棋有很多步)
```

## 附录B：数据库表结构SQL (Schema SQL)

用于在 `MySQL 8.x` 中直接执行以创建数据库和表的DML语句。

```sql
-- 创建一个新的数据库（如果还没创建的话）
CREATE DATABASE IF NOT EXISTS zeus_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 切换到我们的数据库
USE zeus_db;

-- ----------------------------
-- 表 1: tbl_user (用户表 - 简化设计)
-- 职责：存储用户信息
-- ----------------------------
CREATE TABLE IF NOT EXISTS `tbl_user` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户主键ID',
  `username` VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
  `password_hash` VARCHAR(255) NOT NULL COMMENT '加盐后的密码哈希 (安全起见，从不存明文)',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户信息表';


-- ----------------------------
-- 表 2: tbl_game_pgn (棋局表)
-- 职责：存储用户上传的PGN原文和对局元信息
-- ----------------------------
CREATE TABLE IF NOT EXISTS `tbl_game_pgn` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '棋局主键ID',
  `user_id` BIGINT NOT NULL COMMENT '上传者ID (关联tbl_user)',
  `pgn_content` TEXT NOT NULL COMMENT 'PGN棋谱原文',
  `white_player` VARCHAR(100) DEFAULT 'Unknown' COMMENT '白方棋手',
  `black_player` VARCHAR(100) DEFAULT 'Unknown' COMMENT '黑方棋手',
  `game_result` VARCHAR(20) DEFAULT '*' COMMENT '对局结果 (e.g., 1-0, 0-1, 1/2-1/2)',
  `game_date` VARCHAR(50) DEFAULT '????.??.??' COMMENT '对局日期',
  `analysis_status` ENUM('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED') NOT NULL DEFAULT 'PENDING' COMMENT '分析状态 (WBS 3.1.2)',
  `uploaded_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`) USING BTREE COMMENT '为用户ID创建索引，加快查询'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='棋局PGN数据表';


-- ----------------------------
-- 表 3: tbl_analysis_result (分析结果表)
-- 职责：存储Stockfish分析后的每一步棋的数据 (WBS 3.1.1)
-- ----------------------------
CREATE TABLE IF NOT EXISTS `tbl_analysis_result` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '分析结果主键ID',
  `game_id` BIGINT NOT NULL COMMENT '关联的棋局ID (tbl_game_pgn)',
  `move_number` INT NOT NULL COMMENT '步数 (例如: 1, 2, 3...)',
  `move_san` VARCHAR(20) NOT NULL COMMENT '该步的SAN表示法 (如: e4, Nf3)',
  `score` VARCHAR(20) NOT NULL COMMENT 'AI评分 (存字符串，e.g., +120, -50, M5, #3)',
  `best_move` VARCHAR(20) NOT NULL COMMENT 'AI认为的最佳走法 (UCI格式, e.g., e2e4, g1f3)',
  `move_classification` ENUM('BRILLIANT', 'GOOD', 'INACCURACY', 'MISTAKE', 'BLUNDER', 'BEST') DEFAULT NULL COMMENT '自研算法的走法分类 (WBS 3.1.1 & 3.2.4)',
  PRIMARY KEY (`id`),
  -- 这是一个复合唯一索引，确保同一局棋的同一步数只有一条分析结果
  UNIQUE KEY `uk_game_move` (`game_id`, `move_number`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AI异步分析结果表';
```